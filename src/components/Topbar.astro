---
import { useTranslations, getLangFromUrl } from "../i18n/ui";
import LangSwitcher from "./LangSwitcher.astro";
import { bookingTerms } from "../i18n/content";
const t = useTranslations(Astro);
const lang = getLangFromUrl(Astro.url);
---

<header class="sticky top-0 bg-[#fff] backdrop-saturate-150 backdrop-blur z-20">
  <div
    class="mx-auto w-full max-w-[1170px] px-5 flex items-center justify-between py-4"
  >
    <div class="font-logo text-main-rose" aria-label="Vlada Polianskaya">
      Vlada<br />Polyanskaya
    </div>

    <!-- Toggle (CSS-only via peer) -->
    <label
      for="nav-toggle"
      class="lg:hidden cursor-pointer p-2 -m-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#3e5348] focus:ring-offset-2"
      aria-label="Menu"
      aria-controls="site-nav"
    >
      <svg
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        class="w-7 h-7 text-[#333]"
        ><path d="M3 6h18M3 12h18M3 18h18"></path></svg
      >
    </label>
    <input id="nav-toggle" type="checkbox" class="peer hidden" />

    <nav
      id="site-nav"
      aria-label="Main navigation"
      class="absolute left-0 right-0 top-full bg-[#fff] border-t border-b border-[#e6e6e6] shadow-[0_10px_30px_rgba(0,0,0,0.06)] opacity-0 -translate-y-2 pointer-events-none transition-opacity transition-transform duration-200 ease-out peer-checked:opacity-100 peer-checked:translate-y-0 peer-checked:pointer-events-auto lg:static lg:opacity-100 lg:translate-y-0 lg:pointer-events-auto lg:shadow-none lg:border-none lg:bg-transparent lg:transition-none lg:duration-0 motion-reduce:transition-none"
    >
      <ul class="flex flex-col lg:flex-row lg:items-center lg:gap-7 m-0 p-0 list-none">
        <li class="border-t first:border-t-0 border-[#e6e6e6] lg:border-0">
          <a
            href="#about"
            class="nav-link block px-5 py-4 lg:px-0 lg:py-2 font-medium text-[14px] tracking-[0.04em] active:bg-[#f2f0e6] lg:active:bg-transparent"
            >{t("nav.about")}</a
          >
        </li>
        <li class="border-t first:border-t-0 border-[#e6e6e6] lg:border-0">
          <a
            href="#portfolio"
            class="nav-link block px-5 py-4 lg:px-0 lg:py-2 font-medium text-[14px] tracking-[0.04em] active:bg-[#f2f0e6] lg:active:bg-transparent"
            >{t("nav.portfolio")}</a
          >
        </li>
        <li class="border-t first:border-t-0 border-[#e6e6e6] lg:border-0">
          <a
            href="#services"
            class="nav-link block px-5 py-4 lg:px-0 lg:py-2 font-medium text-[14px] tracking-[0.04em] active:bg-[#f2f0e6] lg:active:bg-transparent"
            >{t("nav.services")}</a
          >
        </li>
        <li class="border-t first:border-t-0 border-[#e6e6e6] lg:border-0">
          <a
            href="#contacts"
            class="nav-link block px-5 py-4 lg:px-0 lg:py-2 font-medium text-[14px] tracking-[0.04em] active:bg-[#f2f0e6] lg:active:bg-transparent"
            >{t("nav.contacts")}</a
          >
        </li>
        <li class="border-t first:border-t-0 border-[#e6e6e6] lg:border-0">
          <a
            href="#"
            id="nav-booking-terms"
            class="nav-link block px-5 py-4 lg:px-0 lg:py-2 font-medium text-[14px] tracking-[0.04em] active:bg-[#f2f0e6] lg:active:bg-transparent"
            >{t("nav.booking")}</a
          >
        </li>
        <li
          class="border-t first:border-t-0 border-[#e6e6e6] lg:border-0 lg:ml-4"
        >
          <LangSwitcher />
        </li>
      </ul>
    </nav>
  </div>
</header>

<!-- Booking Terms Modal -->
<div id="topbar-modal" class="fixed inset-0 z-50 hidden" aria-hidden="true">
  <div id="topbar-modal-backdrop" class="absolute inset-0 bg-black/50"></div>
  <div
    class="relative mx-auto my-8 max-w-[900px] px-5"
    role="dialog"
    aria-modal="true"
    aria-labelledby="topbar-modal-title"
  >
    <div class="bg-white rounded-md shadow-xl overflow-hidden">
      <div
        class="flex items-center justify-between px-5 py-4 border-b border-[#eee]"
      >
        <h3 id="topbar-modal-title" class="text-xl font-semibold m-0">
          {t("modal.bookingTitle")}
        </h3>
        <button
          id="topbar-modal-close"
          type="button"
          class="inline-flex items-center justify-center text-[#666] hover:text-[#111] transition-colors"
          aria-label="Close"
        >
          âœ•
        </button>
      </div>
      <div
        id="topbar-modal-content"
        class="px-5 py-5 leading-relaxed text-[#444] overflow-y-auto max-h-[75vh]"
      >
      </div>
    </div>
  </div>
</div>

<!-- Hidden booking terms template (localized) -->
<div id="booking-terms-template" class="hidden" set:html={bookingTerms[lang]} />

<script is:inline>
  function initTopbar() {
    const btn = document.getElementById("nav-booking-terms");
    const toggle = document.getElementById("nav-toggle");
    // Modal refs
    const modal = document.getElementById("topbar-modal");
    const modalContent = document.getElementById("topbar-modal-content");
    const modalClose = document.getElementById("topbar-modal-close");
    const modalBackdrop = document.getElementById("topbar-modal-backdrop");

    function openModal() {
      if (!modal || !modalContent) return;
      const tpl = document.getElementById("booking-terms-template");
      const html = tpl ? tpl.innerHTML : "";
      modalContent.innerHTML = `<div class=\"text-[#555] leading-relaxed space-y-3\">${html}</div>`;
      modal.classList.remove("hidden");
      document.body.style.overflow = "hidden";
    }
    function closeModal() {
      if (!modal) return;
      modal.classList.add("hidden");
      document.body.style.overflow = "";
    }

    modalClose?.addEventListener("click", closeModal, { passive: true });
    modalBackdrop?.addEventListener("click", closeModal, { passive: true });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && !modal?.classList.contains("hidden"))
        closeModal();
    });

    if (btn) {
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        // close mobile menu if open
        if (toggle && toggle.checked) toggle.checked = false;
        openModal();
      });
    }
  }
  document.addEventListener("astro:page-load", initTopbar);
  document.addEventListener("astro:after-swap", initTopbar);
  document.addEventListener("DOMContentLoaded", initTopbar);
</script>

<style>
  /* Minimal, elegant fade effect */
  .nav-link {
    color: #3a3a3a;
    opacity: 0.75;
    transition:
      color 180ms ease,
      opacity 180ms ease;
  }
  .nav-link:hover,
  .nav-link:focus-visible {
    color: #111;
    opacity: 1;
    outline: none;
  }
  @media (prefers-reduced-motion: reduce) {
    .nav-link {
      transition: none;
    }
  }
</style>
